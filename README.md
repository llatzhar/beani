# beani

楽曲を流しながら曲のbpmに合わせてアニメーションを行うムービープログラムを
簡単につくれるようにしたい。

* 曲の再生とアニメーションにpygameを使用
* ムービーは複数のシーンの組み合わせである
* シーンはpygameのupdateとdrawを定義する
* updateとdrawはコード内に定義したfpsごとにコールされるが、
  BPMと曲の拍子数から、on_beatがコールされる
  120BPMの場合、60秒で120回on_beatが呼ばれるようにする。
  fps=30だったら何frame毎にon_beatする？
* シーン内の画面にはDrawableオブジェクトを配置する。
* 4拍子の曲であれば、on_beat(0),on_beat(1),on_beat(2),on_beat(3),on_beat(0),....と拍子数をパラメータにつけてコールされるので
  各シーン内のDrawableオブジェクトはアニメーションのupdateをしつつ、on_beatで曲のビートのタイミングに合わせたupdate処理を行う
* シーン内にはDrawableの子オブジェクトが多数配置してupdateとon_beatで形状を変えながらアニメーションしていく
* ZoomBeaterオブジェクトはDrawableの一種で、コンストラクタで指定した画像を表示する。on_beatのタイミングで画像を拡大/縮小表示し、
  3フレームで元のサイズに戻す。

## movie1.py

ZoomBeaterのサンプル。
images/star_1.pngをビートに合わせて拡大表示する例
fps=30, base.mp3を再生する。BPM=120

### 実装済み機能

#### 基本アーキテクチャ
- **Drawableクラス**: 描画可能オブジェクトの基底クラス（update, on_beat, drawメソッド）
- **ZoomBeaterクラス**: ビートに合わせて画像を拡大/縮小するDrawableオブジェクト
- **Sceneクラス**: 複数のDrawableオブジェクトを管理するコンテナ
- **Movieクラス**: メインのムービー制御とビート検出システム

#### ビート同期システム
- **実時間ベースのビート検出**: フレーム数ではなく実際の経過時間でビートを計算
- **音楽再生位置同期**: `pygame.mixer.music.get_pos()`で音楽の実際の位置を取得し、より正確な同期を実現
- **重複ビート処理防止**: 同じビートで複数回`on_beat()`が呼ばれることを防止
- **フォールバック機能**: 音楽位置が取得できない場合は実時間ベースにフォールバック

#### パフォーマンス最適化
- **FPS監視**: リアルタイムでFPS監視、目標値の80%以下でデバッグ情報表示
- **重い処理対応**: updateやdrawが重くてFPSが下がっても曲とアニメーションがずれない設計
- **画面表示**: パフォーマンス低下時に画面上にFPS情報を表示

#### 操作・デバッグ機能
- **スペースキー**: 音楽の再生/停止切り替え
- **Hキー**: 重い処理シミュレーションのON/OFF切り替え（デバッグ用）
- **複数オブジェクト**: パフォーマンステスト用に複数のZoomBeaterを配置

#### ZoomBeaterの詳細仕様
- コンストラクタで画像パス、位置、スケール、ズーム倍率を指定
- `on_beat()`でズーム倍率まで即座に拡大
- 3フレームかけて元のサイズに滑らかに縮小
- 重い処理シミュレーション機能付き（10ms遅延）

### 技術的な改善点

#### 曲とアニメーションのずれ防止策
1. **実時間ベースのビート検出**
   - `pygame.time.get_ticks()`による実際の経過時間でビート計算
   - フレーム落ちの影響を受けない正確なタイミング

2. **音楽再生位置との同期**
   ```python
   music_pos = pygame.mixer.music.get_pos()
   current_beat = int(music_pos / beat_interval_ms)
   ```

3. **パフォーマンス監視**
   - 1秒間のFPSサンプルを保持して平均値を計算
   - 目標FPSの80%以下になったときにアラート

4. **ビート処理の最適化**
   - 前回処理したビート番号を記録し、重複処理を防止
   - ビートが進んだ場合のみ`on_beat()`を呼び出し

### 使用方法

#### 必要なファイル
- `base.mp3`: 音楽ファイル
- `images/star_1.png`: メイン画像
- `images/star_2.png`: サブ画像（オプション）

#### 実行方法
```bash
pip install pygame
python movie1.py
```

#### 動作確認
1. プログラム実行後、音楽が自動再生されビートに合わせてアニメーション開始
2. **Hキー**を押すと重い処理モードになり、FPS低下をシミュレート
3. FPSが下がってもビートタイミングは音楽と正確に同期されることを確認
4. **スペースキー**で音楽の再生/停止テスト

#### BPM設定
現在の設定: BPM=120（`main()`関数内で変更可能）
- BPM=120: 1ビートあたり0.5秒間隔
- fps=30: 15フレームごとにビート発生

### 今後の拡張予定
- 複数シーンの切り替え機能
- より多様なDrawableオブジェクト（回転、移動、色変化など）
- BPM自動検出機能
- 音楽ファイルの波形解析によるより正確な同期
