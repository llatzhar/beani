# beani

楽曲を流しながら曲のbpmに合わせてアニメーションを行うムービープログラムを
簡単につくれるようにしたい。

* 曲の再生とアニメーションにpygameを使用
* ムービーは複数のシーンの組み合わせである
* シーンはpygameのupdateとdrawを定義する
* updateとdrawはコード内に定義したfpsごとにコールされるが、
  BPMと曲の拍子数から、on_beatがコールされる
  120BPMの場合、60秒で120回on_beatが呼ばれるようにする。
  fps=30だったら何frame毎にon_beatする？
* シーン内の画面にはDrawableオブジェクトを配置する。
* 4拍子の曲であれば、on_beat(0),on_beat(1),on_beat(2),on_beat(3),on_beat(0),....と拍子数をパラメータにつけてコールされるので
  各シーン内のDrawableオブジェクトはアニメーションのupdateをしつつ、on_beatで曲のビートのタイミングに合わせたupdate処理を行う
* シーン内にはDrawableの子オブジェクトが多数配置してupdateとon_beatで形状を変えながらアニメーションしていく
* ZoomBeaterオブジェクトはDrawableの一種で、コンストラクタで指定した画像を表示する。on_beatのタイミングで画像を拡大/縮小表示し、
  3フレームで元のサイズに戻す。

## movie1.py

ZoomBeaterのサンプル。
images/star_1.pngをビートに合わせて拡大表示する例
fps=30, base.mp3を再生する。BPM=120

### 実装済み機能

#### 基本アーキテクチャ
- **Drawableクラス**: 描画可能オブジェクトの基底クラス（update, on_beat, drawメソッド）
- **ZoomBeaterクラス**: ビートに合わせて画像を拡大/縮小するDrawableオブジェクト
- **FlashBeaterクラス**: ビートに合わせて色が変化する円形オブジェクト
- **Sceneクラス**: 複数のDrawableオブジェクトを管理するコンテナ
- **Countdownクラス**: 音楽開始前のカウントダウン表示（独立モジュール）
- **Movieクラス**: メインのムービー制御とビート検出システム

#### カウントダウンシステム
- **独立モジュール**: `countdown.py`として分離されたカウントダウン機能
- **ビート同期カウントダウン**: 音楽のBPMに合わせて正確にカウントダウンを表示
- **視覚効果**: フラッシュ効果と円形背景による視覚的なカウントダウン表示
- **情報表示**: "Get ready! Music starts after countdown"メッセージの点滅表示
- **自動音楽開始**: カウントダウン完了後に自動的に音楽とシーン再生が開始

#### ビート同期システム
- **実時間ベースのビート検出**: フレーム数ではなく実際の経過時間でビートを計算
- **音楽再生位置同期**: `pygame.mixer.music.get_pos()`で音楽の実際の位置を取得し、より正確な同期を実現
- **重複ビート処理防止**: 同じビートで複数回`on_beat()`が呼ばれることを防止
- **フォールバック機能**: 音楽位置が取得できない場合は実時間ベースにフォールバック

#### パフォーマンス最適化
- **FPS監視**: リアルタイムでFPS監視、目標値の80%以下でデバッグ情報表示
- **重い処理対応**: updateやdrawが重くてFPSが下がっても曲とアニメーションがずれない設計
- **画面表示**: パフォーマンス低下時に画面上にFPS情報を表示

#### 操作・デバッグ機能
- **スペースキー**: カウントダウン付きで音楽再生開始 / 音楽停止
- **Enterキー**: カウントダウンなしで即座に音楽再生開始
- **Hキー**: 重い処理シミュレーションのON/OFF切り替え（デバッグ用）
- **複数オブジェクト**: パフォーマンステスト用に複数のZoomBeaterを配置

#### ZoomBeaterの詳細仕様
- コンストラクタで画像パス、位置、スケール、ズーム倍率を指定
- `on_beat()`でズーム倍率まで即座に拡大
- 3フレームかけて元のサイズに滑らかに縮小
- 重い処理シミュレーション機能付き（10ms遅延）

#### Countdownクラスの詳細仕様

##### 基本機能
- **ビート同期**: 音楽のBPMに正確に合わせたカウントダウン（デフォルト4ビート）
- **視覚表示**: 大きなフォントでカウントダウン数字を表示（200px基本サイズ）
- **フラッシュ効果**: カウントダウン数字が更新される際の拡大・明滅エフェクト
- **背景円**: カウントダウン数字の周囲に表示される円形の視覚効果
- **情報テキスト**: 画面下部に表示される案内メッセージの点滅表示

##### 開始・終了制御

**開始方法（3つの方法）:**
1. **スペースキーで開始**: `movie.play_with_countdown()` - デフォルト4ビートカウントダウン
2. **プログラムで開始**: `movie.start_countdown(countdown_beats)` - 任意のビート数指定可能
3. **自動開始**: `main()`関数内で`movie.play_with_countdown()`が自動実行

**終了条件:**
- **自動終了**: 指定されたビート数（デフォルト4）に到達すると自動完了
- **手動停止**: 音楽再生中にスペースキーで強制停止可能

**内部状態管理:**
```python
class Countdown:
    self.is_active = True     # カウントダウン実行中
    self.is_completed = False # カウントダウン完了状態
    self.current_count = 4    # 表示中のカウント数
```

##### タイミング制御
- **ビート検出**: `pygame.time.get_ticks()`による実時間ベースのビート計算
- **重複防止**: `last_beat_processed`により同一ビートでの重複更新を防止
- **正確な間隔**: `beat_interval_ms`（120BPMで500ms）による正確なタイミング制御

**カウントダウンシーケンス例（4ビート）:**
```
ビート0: "4" 表示開始
ビート1: "3" 表示 + フラッシュ効果
ビート2: "2" 表示 + フラッシュ効果  
ビート3: "1" 表示 + フラッシュ効果
ビート4: カウントダウン完了 → 音楽・シーン開始
```

##### シーンとの連携
- **独立動作**: カウントダウン中は通常シーンの描画・更新を停止
- **シーン無効化**: `Movie.current_scene = -1`で通常シーンを無効化
- **自動切り替え**: カウントダウン完了後に`start_music_and_scenes()`で音楽・シーン開始

### 技術的な改善点

#### 曲とアニメーションのずれ防止策
1. **実時間ベースのビート検出**
   - `pygame.time.get_ticks()`による実際の経過時間でビート計算
   - フレーム落ちの影響を受けない正確なタイミング

2. **音楽再生位置との同期**
   ```python
   music_pos = pygame.mixer.music.get_pos()
   current_beat = int(music_pos / beat_interval_ms)
   ```

3. **パフォーマンス監視**
   - 1秒間のFPSサンプルを保持して平均値を計算
   - 目標FPSの80%以下になったときにアラート

4. **ビート処理の最適化**
   - 前回処理したビート番号を記録し、重複処理を防止
   - ビートが進んだ場合のみ`on_beat()`を呼び出し

### 使用方法

#### 必要なファイル
- `base.mp3`: 音楽ファイル（musicsフォルダ内）
- `images/star_1.png`: メイン画像
- `images/star_2.png`: サブ画像（オプション）

#### プロジェクト構成
```
beani/
├── movie1.py          # メインムービープログラム
├── countdown.py       # カウントダウン機能（独立モジュール）
├── resources.py       # リソース管理
├── musics/
│   └── base.mp3      # 音楽ファイル
└── images/
    ├── star_1.png    # 必須画像
    └── star_2.png    # オプション画像
```

#### 実行方法
```bash
pip install pygame
python movie1.py
```

#### コントロール
- **スペースキー**: カウントダウン付きで再生開始 / 音楽停止
- **Enterキー**: カウントダウンなしで即座に再生開始  
- **Hキー**: 重い処理シミュレーションのON/OFF
- **ESCキー**: プログラム終了

#### 動作確認
1. プログラム実行後、4秒間のカウントダウンが自動開始（"4", "3", "2", "1"）
2. カウントダウン完了後に音楽が自動再生され、ビートに合わせてアニメーション開始
3. **スペースキー**で音楽停止、再度押すとカウントダウンから再開
4. **Enterキー**でカウントダウンをスキップして即座に音楽再生
5. **Hキー**を押すと重い処理モードになり、FPS低下をシミュレート
6. FPSが下がってもビートタイミングは音楽と正確に同期されることを確認

#### BPM設定
現在の設定: BPM=120（`main()`関数内で変更可能）
- BPM=120: 1ビートあたり0.5秒間隔
- fps=30: 15フレームごとにビート発生

### 今後の拡張予定
- 複数シーンの切り替え機能（実装済み）
- カウントダウン時間のカスタマイズ機能
- カウントダウンの視覚効果カスタマイズ
- より多様なDrawableオブジェクト（回転、移動、色変化など）
- BPM自動検出機能
- 音楽ファイルの波形解析によるより正確な同期
